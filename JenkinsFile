pipeline {
    agent { label 'master'}
    options{
        timestamps()
           }     
    stages {
        stage('Git Checkout') {
            steps {
                echo 'Hello World'
            }
        }
        stage('Build frontend'){
            options {
                timeout(time: 1, unit: "HOURS")
            }
            when {
                expression { 
                    params.DEPLOYMENT == 'frontend'
                }
            }
            steps {
                echo "Building"
                 sshagent(['Test123']) {
                    sh """
                    echo '${DEPLOYMENT}'
                    echo 'params.DEPLOYMENT'
                    echo '#!/bin/bash  
                          hostname
            cd /home/ubuntu/docker/frontend/code
            git pull origin master
            cd /home/ubuntu/docker/
            ls -l
            docker-compose build --no-cache --force-rm frontend
            docker-compose up -d --force-recreate --no-deps frontend
            docker ps -a
            ' > script.sh
            cat script.sh
            ssh -o 'StrictHostKeyChecking no' -t ubuntu@52.60.236.156 'bash -s -- uno' < script.sh
                        """
                 }
                //sleep 5
            }
        }
        stage('Build Backend'){
            options {
                timeout(time: 1, unit: "HOURS")
            }
            
            when {
                expression { 
                   params.DEPLOYMENT == 'backend'
                }
            }
            steps {
                echo "Building Backend"
                 sshagent(['Test123']) {
                    sh """
                    echo '#!/bin/bash  
                          hostname
            cd /home/ubuntu/docker/backend/code
            git pull origin master
            cd /home/ubuntu/docker/
            ls -l
            docker-compose build --no-cache --force-rm backend
            docker-compose up -d --force-recreate --no-deps backend
            docker ps -a
            ' > script.sh
            cat script.sh
            ssh -o 'StrictHostKeyChecking no' -t ubuntu@52.60.236.156 'bash -s -- uno' < script.sh
                        """
                 }
                //sleep 5
            }
        }
        stage('Test'){
            steps{
                echo "Testing123"   
            }
    }
}
 post { 
        always { 
            cleanWs()
        }
    }
}
